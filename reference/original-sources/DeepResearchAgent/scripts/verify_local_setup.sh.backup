#!/bin/bash
# Comprehensive verification of local-only development setup
# Ensures no online automation is running and all processes are local

set -e

echo "ğŸ” Comprehensive Local-Only Development Verification"
echo "===================================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# 1. Check GitHub CLI authentication
echo ""
print_info("1. Checking GitHub CLI authentication...")
if gh auth status >/dev/null 2>&1; then
    print_success "GitHub CLI authenticated"
else
    print_error "GitHub CLI not authenticated"
    exit 1
fi

# 2. Check repository features
echo ""
print_info("2. Checking repository features...")
REPO_INFO=$(gh repo view kairin/DeepResearchAgent --json hasIssuesEnabled,hasProjectsEnabled,hasWikiEnabled,hasDiscussionsEnabled,isSecurityPolicyEnabled 2>/dev/null || echo "{}")

if echo "$REPO_INFO" | grep -q '"hasIssuesEnabled": false' && \
   echo "$REPO_INFO" | grep -q '"hasProjectsEnabled": false' && \
   echo "$REPO_INFO" | grep -q '"hasWikiEnabled": false' && \
   echo "$REPO_INFO" | grep -q '"hasDiscussionsEnabled": false'; then
    print_success "Repository features disabled (no charges)"
else
    print_warning "Some repository features may be enabled"
fi

# 3. Check workflows on user's fork
echo ""
print_info("3. Checking workflows on fork...")
WORKFLOW_COUNT=$(gh workflow list --repo kairin/DeepResearchAgent 2>/dev/null | wc -l || echo "0")

if [ "$WORKFLOW_COUNT" -eq 0 ] || [ "$WORKFLOW_COUNT" -eq 1 ]; then
    print_success "No workflows on fork (no charges)"
else
    print_warning "Found workflows on fork - should be disabled"
fi

# 4. Check upstream workflows (informational)
echo ""
print_info("4. Checking upstream repository workflows...")
UPSTREAM_WORKFLOWS=$(gh workflow list --repo SkyworkAI/DeepResearchAgent 2>/dev/null | grep -c "active" || echo "0")
if [ "$UPSTREAM_WORKFLOWS" -gt 0 ]; then
    print_info "Upstream has $UPSTREAM_WORKFLOWS active workflows (does not affect fork)"
else
    print_success "No active workflows on upstream"
fi

# 5. Check workflow file configurations
echo ""
print_info("5. Checking workflow file configurations...")
check_workflow_disabled() {
    local file="$1"
    local name="$2"

    if [ -f "$file" ]; then
        # Check if all triggers are commented out and workflow_call is present
        if grep -q "workflow_call:" "$file" && \
           ! grep -q "^  push:\|^  pull_request:\|^  workflow_dispatch:" "$file" && \
           grep -q "# push:\|# pull_request:\|# workflow_dispatch:" "$file"; then
            print_success "$name workflow properly disabled"
        else
            print_warning "$name workflow may still have active triggers"
        fi
    else
        print_success "$name workflow file not found"
    fi
}

check_workflow_disabled ".github/workflows/ci-cd.yml" "CI/CD Pipeline"
check_workflow_disabled ".github/workflows/ci.yml" "CI"
check_workflow_disabled ".github/workflows/deploy.yml" "Deploy"

# 6. Check branch protection
echo ""
print_info("6. Checking branch protection...")
BRANCH_PROTECTION=$(gh api repos/kairin/DeepResearchAgent/branches/main/protection 2>/dev/null || echo "404")
if echo "$BRANCH_PROTECTION" | grep -q "404"; then
    print_success "No branch protection rules (no CI requirements)"
else
    print_warning "Branch protection rules exist - check for CI requirements"
fi

# 7. Check webhooks
echo ""
print_info("7. Checking webhooks...")
WEBHOOK_COUNT=$(gh api repos/kairin/DeepResearchAgent/hooks 2>/dev/null | jq '. | length' 2>/dev/null || echo "0")
if [ "$WEBHOOK_COUNT" -eq 0 ]; then
    print_success "No webhooks configured"
else
    print_warning "Found $WEBHOOK_COUNT webhook(s) - verify they don't trigger automation"
fi

# 8. Check local automation scripts
echo ""
print_info("8. Checking local automation scripts...")
if [ -x "scripts/local_ci_cd.sh" ]; then
    print_success "Local CI/CD script available"
else
    print_error "Local CI/CD script missing or not executable"
fi

if [ -x "scripts/run_comprehensive_tests.py" ]; then
    print_success "Local test script available"
else
    print_error "Local test script missing or not executable"
fi

if [ -x "scripts/validate_migration.py" ]; then
    print_success "Migration validation script available"
else
    print_warning "Migration validation script missing"
fi

# 9. Check git hooks
echo ""
print_info("9. Checking git protection hooks...")
if [ -x ".git/hooks/pre-merge-commit" ]; then
    print_success "Pre-merge validation hook active"
else
    print_warning "Pre-merge validation hook missing"
fi

# 10. Check uv and Python setup
echo ""
print_info("10. Checking development environment...")
if command -v uv >/dev/null 2>&1; then
    UV_VERSION=$(uv --version)
    print_success "uv installed: $UV_VERSION"
else
    print_error "uv not installed - required for local development"
fi

if command -v python3 >/dev/null 2>&1; then
    PYTHON_VERSION=$(python3 --version)
    if echo "$PYTHON_VERSION" | grep -q "Python 3.13"; then
        print_success "Python 3.13 available: $PYTHON_VERSION"
    else
        print_warning "Python 3.13 not detected: $PYTHON_VERSION"
    fi
else
    print_error "Python 3 not found"
fi

# 11. Check dependency lock
echo ""
print_info("11. Checking dependency management...")
if [ -f "uv.lock" ]; then
    print_success "uv.lock file exists"
else
    print_error "uv.lock file missing"
fi

# 12. Check documentation
echo ""
print_info("12. Checking documentation...")
if [ -f "LOCAL_DEVELOPMENT.md" ]; then
    print_success "Local development documentation available"
else
    print_warning "Local development documentation missing"
fi

if [ -f "README.md" ] && grep -q "LOCAL_DEVELOPMENT.md" README.md; then
    print_success "README references local development guide"
else
    print_warning "README may not reference local development guide"
fi

# Final summary
echo ""
echo "===================================================="
echo "ğŸ‰ VERIFICATION COMPLETE"
echo "===================================================="
echo ""
echo "ğŸ’° COST PREVENTION STATUS:"
echo "  âŒ GitHub Actions: $([ "$WORKFLOW_COUNT" -eq 0 ] && echo "Disabled" || echo "Check Required")"
echo "  âŒ Repository Features: $(echo "$REPO_INFO" | grep -q '"hasIssuesEnabled": false' && echo "Disabled" || echo "Check Required")"
echo "  âœ… Local Automation: $([ -x "scripts/local_ci_cd.sh" ] && echo "Available" || echo "Missing")"
echo "  âœ… Git Protection: $([ -x ".git/hooks/pre-merge-commit" ] && echo "Active" || echo "Missing")"
echo ""
echo "ğŸš€ QUICK START:"
echo "  Verify setup: ./scripts/verify_local_setup.sh"
echo "  Run CI/CD: ./scripts/local_ci_cd.sh"
echo "  Run tests: uv run python scripts/run_comprehensive_tests.py"
echo ""
echo "ğŸ“– DOCUMENTATION:"
echo "  Local Development: LOCAL_DEVELOPMENT.md"
echo "  Repository Guide: README.md"
echo ""
echo "ğŸ›¡ï¸ PROTECTION:"
echo "  - All online automation disabled"
echo "  - Local validation required"
echo "  - Archive branch strategy enforced"
echo "  - Zero-cost development guaranteed"
WORKFLOW_COUNT=$(gh workflow list --repo kairin/DeepResearchAgent 2>/dev/null | wc -l || echo "0")

if [ "$WORKFLOW_COUNT" -eq 0 ] || [ "$WORKFLOW_COUNT" -eq 1 ]; then
    print_success "No workflows on fork (no charges)"
else
    print_warning "Found workflows on fork - should be disabled"
fi

# Check workflow files are disabled
echo "ğŸ“„ Checking workflow file configurations..."
check_workflow_disabled() {
    local file="$1"
    local name="$2"

    if [ -f "$file" ]; then
        # Check if all triggers are commented out and workflow_call is present
        if grep -q "workflow_call:" "$file" && \
           ! grep -q "^  push:\|^  pull_request:\|^  workflow_dispatch:" "$file" && \
           grep -q "# push:\|# pull_request:\|# workflow_dispatch:" "$file"; then
            print_success "$name workflow properly disabled"
        else
            print_warning "$name workflow may still have active triggers"
        fi
    else
        print_success "$name workflow file not found"
    fi
}

check_workflow_disabled ".github/workflows/ci-cd.yml" "CI/CD Pipeline"
check_workflow_disabled ".github/workflows/ci.yml" "CI"
check_workflow_disabled ".github/workflows/deploy.yml" "Deploy"

# Check local scripts exist
echo "ğŸ› ï¸  Checking local automation scripts..."
if [ -x "scripts/local_ci_cd.sh" ]; then
    print_success "Local CI/CD script available"
else
    print_error "Local CI/CD script missing or not executable"
fi

if [ -x "scripts/run_comprehensive_tests.py" ]; then
    print_success "Local test script available"
else
    print_error "Local test script missing or not executable"
fi

# Check git hooks
echo "ğŸª Checking git protection hooks..."
if [ -x ".git/hooks/pre-merge-commit" ]; then
    print_success "Pre-merge validation hook active"
else
    print_warning "Pre-merge validation hook missing"
fi

# Check uv installation
echo "ğŸ“¦ Checking uv package manager..."
if command -v uv >/dev/null 2>&1; then
    UV_VERSION=$(uv --version)
    print_success "uv installed: $UV_VERSION"
else
    print_error "uv not installed - required for local development"
fi

# Check Python version
echo "ğŸ Checking Python version..."
if command -v python3 >/dev/null 2>&1; then
    PYTHON_VERSION=$(python3 --version)
    if echo "$PYTHON_VERSION" | grep -q "Python 3.13"; then
        print_success "Python 3.13 available: $PYTHON_VERSION"
    else
        print_warning "Python 3.13 not detected: $PYTHON_VERSION"
    fi
else
    print_error "Python 3 not found"
fi

# Check uv.lock exists
echo "ğŸ”’ Checking dependency lock..."
if [ -f "uv.lock" ]; then
    print_success "uv.lock file exists"
else
    print_error "uv.lock file missing"
fi

# Final summary
echo ""
echo "=================================================="
echo "ğŸ‰ Local-Only Development Verification Complete!"
echo "=================================================="
echo ""
echo "ğŸ’° Cost Prevention Status:"
echo "  âŒ GitHub Actions: Disabled"
echo "  âŒ Repository Features: Disabled"
echo "  âœ… Local Automation: Available"
echo "  âœ… Git Protection: Active"
echo ""
echo "ğŸš€ Ready for local development!"
echo "  Run: ./scripts/local_ci_cd.sh"
echo ""
echo "ğŸ“– See: LOCAL_DEVELOPMENT.md for details"